---
page_title: HCP Vault Secrets-Backed Dynamic Credentials with the AWS Provider - Workspaces - HCP Terraform
description: >-
  Use OpenID Connect and HCP Vault Secrets to get short-term credentials for the AWS Terraform provider in
  your HCP Terraform runs.
---

# HCP Vault Secrets-Backed Dynamic Credentials with the AWS Provider

~> **Important:** If you are self-hosting [HCP Terraform agents](/terraform/cloud-docs/agents), ensure your agents use [v1.8.0](/terraform/cloud-docs/agents/changelog#1-8-0-04-18-2023) or above. To use the latest dynamic credentials features, [upgrade your agents to the latest version](/terraform/cloud-docs/agents/changelog).

You can use HCP Terraform’s native OpenID Connect integration with HCP to use [HCP Vault Secrets-backed dynamic credentials](/terraform/cloud-docs/workspaces/dynamic-provider-credentials/hcp-vault-secrets-backed) with the AWS provider in your HCP Terraform runs. Configuring the integration requires the following steps:

1. **[Configure HCP Provider Credentials](#configure-hcp-provider-credentials)**: Set up a trust configuration between HCP Vault Secrets and HCP Terraform, create HCP roles and policies for your HCP Terraform workspaces, and add environment variables to those workspaces.
2. **[Configure the HCP Vault Secrets AWS Secrets Engine](#configure-hcp-vault-secrets-aws-secrets-engine)**: Set up the AWS secrets engine in your HCP instance.
3. **[Configure HCP Terraform](#configure-hcp-terraform)**: Add additional environment variables to the HCP Terraform workspaces where you want to use HCP Vault Secrets-backed dynamic credentials.
4. **[Configure Terraform Providers](#configure-terraform-providers)**: Configure your Terraform providers to work with HCP Vault Secrets-backed dynamic credentials.

Once you complete this setup, HCP Terraform automatically authenticates with AWS via HCP Vault Secrets-generated credentials during the plan and apply phase of each run. The AWS provider's authentication is only valid for the length of the plan or apply phase.

## Configure HCP Provider Credentials
You must first set up HCP dynamic provider credentials before you can use HCP Vault Secrets-backed dynamic credentials. This includes setting up the JWT auth backend in HCP Vault Secrets, configuring trust between HCP Terraform and HCP Vault Secrets, and populating the required environment variables in your HCP Terraform workspace.

[See the setup instructions for HCP dynamic provider credentials](/terraform/cloud-docs/workspaces/dynamic-provider-credentials/hcp-configuration).

# Configure HCP Vault Secrets AWS Secrets Engine
Follow the instructions in the HCP Vault Secrets documentation for [setting up the AWS secrets engine in your HCP instance](/hcp/docs/vault-secrets/dynamic-secrets/aws). You can also do this configuration through Terraform. Refer to our [example Terraform configuration](https://github.com/hashicorp/terraform-dynamic-credentials-setup-examples/hcp-vault-secrets-backed/aws).

~> **Important**: carefully consider the limitations and differences between each supported credential type in the AWS secrets engine. These limitations carry over to HCP Terraform’s usage of these credentials for authenticating the AWS provider.

## Configure HCP Terraform
Next, you need to set certain environment variables in your HCP Terraform workspace to authenticate HCP Terraform with AWS using HCP Vault Secrets-backed dynamic credentials. These variables are in addition to those you previously set while configuring [HCP provider credentials](#configure-hcp-provider-credentials). You can add these as workspace variables or as a [variable set](/terraform/cloud-docs/workspaces/variables/managing-variables#variable-sets).
### Common Environment Variables
The below variables apply to all AWS auth types.

#### Required Common Environment Variables
| Variable                                                                                                | Value                                                                        | Notes                                                                                                                                                  |
|---------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| `TFC_HVS_BACKED_AWS_AUTH`<br />`TFC_HVS_BACKED_AWS_AUTH[_TAG]`<br />_(Default variable not supported)_  | `true`                                                                       | Requires **v1.8.0** or later if self-managing agents. Must be present and set to `true`, or HCP Terraform will not attempt to authenticate with AWS.   |
| `TFC_HVS_BACKED_AWS_RUN_APP_NAME`                                                                       | The name of the HCP Vault Secrets app that will contain the dynamic secret.  | Requires **v1.8.0** or later if self-managing agents. Must be present.                                                                                 |
| `TFC_HVS_BACKED_AWS_RUN_SECRET_NAME`                                                                    | The name of the HCP Vault Secrets dynamic secret to read.                    | Requires **v1.8.0** or later if self-managing agents. Must be present.                                                                                 |

#### Optional Common Environment Variables
You may need to set these variables, depending on your use case.

| Variable                                                                                                                    | Value                                                                                                                                                                                               | Notes                                                                                                                                      |
|-----------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| `TFC_HVS_BACKED_AWS_HCP_CONFIG`<br />`TFC_HVS_BACKED_AWS_HCP_CONFIG[_TAG]`<br />`TFC_DEFAULT_HVS_BACKED_AWS_HCP_CONFIG`     | The name of the non-default HCP configuration for workspaces using [multiple HCP configurations](/terraform/cloud-docs/workspaces/dynamic-provider-credentials/specifying-multiple-configurations). | Requires **v1.12.0** or later if self-managing agents. Will fall back to using the default HCP Vault Secrets configuration if not provided.|
| `TFC_HVS_BACKED_AWS_PLAN_APP_NAME`                                                                                          | The name of the HCP Vault Secrets app that will contain the dynamic secret for the plan phase of a run.                                                                                             | Requires **v1.8.0** or later if self-managing agents. Must be present.                                                                     |
| `TFC_HVS_BACKED_AWS_APPLY_APP_NAME`                                                                                         | The name of the HCP Vault Secrets app that will contain the dynamic secret for the apply phase of a run.                                                                                            | Requires **v1.8.0** or later if self-managing agents. Must be present.                                                                     |
| `TFC_HVS_BACKED_AWS_PLAN_SECRET_NAME`                                                                                       | The name of the HCP Vault Secrets dynamic secret to read for the plan phase.                                                                                                                        | Requires **v1.8.0** or later if self-managing agents. Must be present.                                                                     |
| `TFC_HVS_BACKED_AWS_APPLY_SECRET_NAME`                                                                                      | The name of the HCP Vault Secrets dynamic secret to read for the apply phase.                                                                                                                       | Requires **v1.8.0** or later if self-managing agents. Must be present.                                                                     |

## Configure Terraform Providers
The final step is to directly configure your AWS and HCP Vault Secrets providers.

### Configure the AWS Provider
Ensure you pass a value for the `region` argument in your AWS provider configuration block or set the `AWS_REGION` variable in your workspace.

Ensure you are not using any of the arguments or methods mentioned in the [authentication and configuration](https://registry.terraform.io/providers/hashicorp/aws/latest/docs#authentication-and-configuration) section of the provider documentation. Otherwise, these settings may interfere with dynamic provider credentials.

### Configure the HCP Vault Secrets Provider
If you were previously using the HCP provider to authenticate the AWS provider, remove any existing usage of the AWS secrets engine from your Terraform Code.
This includes the [`hvs_aws_access_credentials`](https://registry.terraform.io/providers/hashicorp/hvs/latest/docs/data-sources/aws_access_credentials) data source and any instances of [`hvs_generic_secret`](https://registry.terraform.io/providers/hashicorp/hvs/latest/docs/data-sources/generic_secret) you previously used to generate AWS credentials.

### Specifying Multiple Configurations

~> **Important:** If you are self-hosting [HCP Terraform agents](/terraform/cloud-docs/agents), ensure your agents use [v1.12.0](/terraform/cloud-docs/agents/changelog#1-12-0-07-26-2023) or above. To use the latest dynamic credentials features, [upgrade your agents to the latest version](/terraform/cloud-docs/agents/changelog).

You can add additional variables to handle multiple distinct HCP Vault Secrets-backed AWS setups, enabling you to use multiple [provider aliases](/terraform/language/providers/configuration#alias-multiple-provider-configurations) within the same workspace. You can configure each set of credentials independently, or use default values by configuring the variables prefixed with `TFC_DEFAULT_`.

For more details, see [Specifying Multiple Configurations](/terraform/cloud-docs/workspaces/dynamic-provider-credentials/specifying-multiple-configurations).

#### Required Terraform Variable

To use additional configurations, add the following code to your Terraform configuration. This lets HCP Terraform supply variable values that you can then use to map authentication and configuration details to the correct provider blocks.

```hcl
variable "tfc_hvs_backed_aws_dynamic_credentials" {
  description = "Object containing HCP Vault Secrets-backed AWS dynamic credentials configuration"
  type = object({
    default = object({
      shared_credentials_file = string
    })
    aliases = map(object({
      shared_credentials_file = string
    }))
  })
}
```

#### Example Usage

```hcl
provider "aws" {
  shared_credentials_files = [var.tfc_hvs_backed_aws_dynamic_credentials.default.shared_credentials_file]
}

provider "aws" {
  alias = "ALIAS1"
  shared_credentials_files = [var.tfc_hvs_backed_aws_dynamic_credentials.aliases["ALIAS1"].shared_credentials_file]
}
```
